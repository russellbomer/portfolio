# Terminal Service Docker Compose Configuration
# 
# Services:
# - terminal-server: Node.js WebSocket server bound to 127.0.0.1:4001
# - nginx: Reverse proxy for TLS termination bound to 0.0.0.0:80/443
#
# Security notes:
# - terminal-server binds to localhost only (not exposed externally)
# - nginx handles TLS termination and proxies to terminal-server
# - Session containers spawned by sandboxRunner (requires docker.sock access)
# - DO firewall should limit inbound to 80/443/22 only
#
# MANUAL: Before starting:
# - Set TOKEN_SECRET in environment (openssl rand -hex 32)
# - Issue TLS certificate via certbot
# - Build session image: docker build -t quarry-session:latest -f docker/Dockerfile.session docker/
#
# Usage:
#   docker compose up -d              # Start services
#   docker compose down               # Stop services
#   docker compose logs -f            # View all logs
#   docker compose logs -f terminal   # View terminal server logs
#   docker compose ps                 # Check service status

services:
  terminal-server:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile
    container_name: terminal-server
    restart: unless-stopped

    # Bind to localhost only - nginx proxies external traffic
    ports:
      - "127.0.0.1:4001:4001"

    # Environment configuration
    environment:
      - NODE_ENV=production
      - TERMINAL_PORT=4001
      - TERMINAL_HOST=0.0.0.0
      - TERMINAL_DEBUG=${TERMINAL_DEBUG:-false}
      - TOKEN_SECRET=${TOKEN_SECRET}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-quarry.russellbomer.com}
      - SANDBOX_IMAGE=${SANDBOX_IMAGE:-quarry-session:latest}
      - SESSION_TIMEOUT_SEC=${SESSION_TIMEOUT_SEC:-900}

    # Volumes
    volumes:
      # Session output directory (bind mount for file downloads)
      - ./docker/data/quarry-output:/app/data/quarry-output
      # Docker socket access for spawning session containers
      # RISK: High. Terminal server can spawn/kill containers.
      # MITIGATION: 
      # - Server runs as non-root user in container
      # - Session containers have strict constraints (network none, read-only, etc.)
      # - DO firewall blocks all external docker API access
      # - Server validates all input before container operations
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Resource limits for the terminal server itself
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Healthcheck
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    networks:
      - terminal-net

  nginx:
    image: nginx:1.25-alpine
    container_name: terminal-nginx
    restart: unless-stopped

    # Expose HTTP/HTTPS to the world
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"

    # Mount nginx config and TLS certs
    volumes:
      - ./nginx/sites-available/portfolio.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # TLS certificates (MANUAL: issue via certbot)
      - /etc/letsencrypt:/etc/letsencrypt:ro

    # Depends on terminal server
    depends_on:
      terminal-server:
        condition: service_healthy

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required to bind to ports 80/443

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.05"
          memory: 32M

    # Healthcheck
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

    networks:
      - terminal-net

networks:
  terminal-net:
    driver: bridge
